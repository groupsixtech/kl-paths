PROGRAM test_paths
%NOBUSYLAMP
%COMMENT = 'test paths'
%NOPAUSE = COMMAND + TPENABLE + ERROR
%STACKSIZE = 1000

%define M_PI 3.14159

--robot config parameters
%define RBT_CONFIG 'F U T, 0, 0, 0'

%ifdef DEBUG_BUILD
%define SHOW_DEBUG FALSE
%define LOG_NAME 'RD:path_debug.DT'
%include display.c.klt
%endif

%include errors.klt
%include systemlib.types.klt
%include systemvars.klt
%include pose.const.klt
%include pathlib.klt
%include pathplan.klt
%include draw.klt

VAR
  contours : PATH nodedata = t_VEC_PATH
  lines : PATH nodedata = t_VEC_PATH
  polygon : PATH nodedata = t_VERTEX
  ppath : PATH nodedata = t_POS_PATH
  path_plan : PATH nodedata = t_INTEGER
  pth : PATH nodedata = t_TOOLPATH

%include kunit.klh
%from systemlib.klh %import VEC, VEC2D
%include errors.klh
%include pose.klh
%from strings.klh %import i_to_s, p_to_s, pose_to_s
%from registers.klh %import set_real, set_int
%include pathlib.klh

--planning object
%class tstpln('pathplan.klc','pathplan.klh','vecpathplan.klt')
define_pplan_headers(tstpln)

--dont load in full pathmake
--only load in interface as `convertOrientation`
--is all that is needed
%include path.impl.klt
define_pmake_members(tspth)

%include path.impl.orientation.klt
define_pmake_members(tsorn)

%include path.impl.surf.klt
define_pmake_members(tssrf)

--polygon object
%class tstpoly('polygon.klc', 'polygon.klh')

%ifdef DEBUG_BUILD
-- user display log
%class usrdis('dispclass.klc','dispclass.klh')
%endif

ROUTINE clear_poly(p : PATH nodedata = t_VERTEX)
  VAR
    i, status : INTEGER
  BEGIN
    i = PATH_LEN(p)
    WHILE PATH_LEN(p) > 0 DO
		  DELETE_NODE(p,i,status)
      i = i - 1
	  ENDWHILE
  END clear_poly

ROUTINE clear_list(p : PATH nodedata = t_INTEGER)
  VAR
    i, status : INTEGER
  BEGIN
    i = PATH_LEN(p)
    WHILE PATH_LEN(p) > 0 DO
		  DELETE_NODE(p,i,status)
      i = i - 1
	  ENDWHILE
  END clear_list

ROUTINE append_nodes(p : PATH nodedata = t_VERTEX; nodes : INTEGER)
  VAR
    i, status : INTEGER
  BEGIN
    FOR i=1 TO nodes DO
      APPEND_NODE(p,status)
    ENDFOR
  END append_nodes


ROUTINE draw_delta(rast_ang : REAL ; pitch : REAL; wall_lines : INTEGER)
  BEGIN
    --create polygon
    clear_poly(polygon)
    append_nodes(polygon, 8)   
    polygon[1].coords = VEC2D(-40,10)   
    polygon[2].coords = VEC2D(-10,40)   
    polygon[3].coords = VEC2D(0,0)
    polygon[4].coords = VEC2D(10,40)
    polygon[5].coords = VEC2D(40,10)
    polygon[6].coords = VEC2D(20,60)  
    polygon[7].coords = VEC2D(0,120)
    polygon[8].coords = VEC2D(-20,60)

    --initialize polygon object
    tstpln__delete
    tstpoly__init((ZEROPOS(1)), TRUE)
    tstpoly__append_polygon(polygon)

    --raster polygon
    tstpoly__set_params((rast_ang), 1, (wall_lines), 0, (pitch))
    tstpoly__raster(PTH_LINETO)

  END draw_delta

-- ****** flat paths ********
-- *******************************

ROUTINE t_flat_pnts : BOOLEAN
  VAR
    i, j : INTEGER
    origin : XYZWPR
    bbox : t_RECT
    apprch_pnt : t_VEC_PATH
%define SAMPLE_START 50
%define SAMPLE_END 70
%define TOOLING_STEP 6
%define LINKING_STEP 10
%define TOOLING_SPEED 20
%define LINKING_SPEED 60
    act_path, exp_path : ARRAY[11] OF XYZWPR
  BEGIN
    
    --user frame
    origin = POS(130,100,30,0,0,0, (ZEROPOS(1).config_data))

    --draw polygon
    -- (raster angle, pitch, wall_lines)
    draw_delta(0, 10, 1)
    
      --get bounding box
    bbox = tstpoly__get_bounding_box
      --get contours
    paths__clear_vecpath(lines)
    paths__clear_vecpath(contours)
    tstpoly__lines_to_vec_path(lines)
    tstpoly__contours_to_vec_path(contours)

    --generate path
    tstpln__init(lines, origin)
    --(poly_depend, strict_dir)
    tstpln__raster_graph(ONEWAY, FALSE, FALSE)
    -- (add to kd tree)
    tstpln__append_path(contours, FALSE)
     --get start node
    apprch_pnt = paths__new_vpath(bbox.verts[1], PTH_STOP, 0, VEC(1,0,0))
    tstpln__MST(tstpln__closest_point(apprch_pnt))
    
    clear_list(path_plan)
    tstpln__get_plan(path_plan)

    paths__clear_toolpath(pth)

    --set point orientation
    tstpln__set_orientation(DOWN_NORMAL)

    REPEAT
      SELECT (tstpln__next_toolpath) OF
        CASE(PTH_TOOLING):
          tstpln__set_segment_speed(TOOLING_SPEED)
          tstpln__get_toolpath_interpolate(TOOLING_STEP, PTH_LINETO, TRUE, pth)
        CASE(PTH_LINKING):
           tstpln__set_segment_speed(LINKING_SPEED)
          tstpln__get_toolpath_interpolate(LINKING_STEP, PTH_LINETO, TRUE, pth)
      ENDSELECT
    UNTIL( tstpln__is_path_end )

    j = 1
    i=SAMPLE_START
    WHILE i <= SAMPLE_END DO
      act_path[j] = pth[i].v
      i = i + 2
      j = j + 1
    ENDWHILE

    exp_path[1] = POS(147.6, 142.0, 30.0, -180.0, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[2] = POS(126.8, 146.0, 30.0, -180.0, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[3] = POS(106.0, 150.0, 30.0, -180.0, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[4] = POS(112.0, 150.0, 30.0, -180.0, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[5] = POS(124.0, 150.0, 30.0, -180.0, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[6] = POS(136.0, 150.0, 30.0, -180.0, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[7] = POS(148.0, 150.0, 30.0, -180.0, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[8] = POS(154.0, 150.0, 30.0, -180.0, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[9] = POS(132.0, 155.0, 30.0, -180.0, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[10] = POS(110.0, 160.0, 30.0, -180.0, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[11] = POS(116.7, 160.0, 30.0, -180.0, 0.0, 0.0, (ZEROPOS(1).config_data))

    RETURN(kunit_eq_arp(exp_path, act_path))

  END t_flat_pnts


ROUTINE t_hex_pnts : BOOLEAN
  VAR
%define hex_radius 50
%define num_of_points 5
    i, j : INTEGER
    origin : XYZWPR
    bbox : t_RECT
    rast_ang : INTEGER
    wall_lines : INTEGER
    overlap : REAL
%define SAMPLE_START 30
%define SAMPLE_END 40
%define TOOLING_STEP 6
%define LINKING_STEP 10
%define TOOLING_SPEED 20
%define LINKING_SPEED 60
    act_path, exp_path : ARRAY[11] OF XYZWPR
  BEGIN
    origin = POS(0,0,0,0,0,0, pose__set_config(RBT_CONFIG))

    --parameters
    rast_ang = 0
    overlap = 6
    wall_lines = 1

    --draw hexagon
    clear_poly(polygon)
    tstpoly__new
    tstpoly__hexagon(hex_radius, num_of_points, VEC2D(hex_radius, hex_radius), 0)
    --get raster lines
    --     (start_angle, dir, wall_lines, line_width, line_pitch)
    tstpoly__set_params((rast_ang), 1, wall_lines, 0, overlap)
    tstpoly__raster(PTH_LINETO)
    
    paths__clear_vecpath(lines)
    paths__clear_vecpath(contours)
    tstpoly__lines_to_vec_path(lines)
    tstpoly__contours_to_vec_path(contours)

    --generate path
    tstpln__init(lines, origin)
    --(poly_depend, strict_dir)
    tstpln__raster_graph(ONEWAY, FALSE, FALSE)
    -- (add to kd tree)
    tstpln__append_path(contours, FALSE)
     --get start node
    bbox = tstpoly__get_bounding_box
    tstpln__MST(tstpln__closest_bounding_box(2))
    
    clear_list(path_plan)
    tstpln__get_plan(path_plan)

    --set point orientation
    tstpln__set_orientation(DOWN_NORMAL)
    paths__clear_toolpath(pth)

    REPEAT
      SELECT (tstpln__next_toolpath) OF
        CASE(PTH_TOOLING):
          tstpln__set_segment_speed(TOOLING_SPEED)
          tstpln__get_toolpath_interpolate(TOOLING_STEP, PTH_LINETO, TRUE, pth)
        CASE(PTH_LINKING):
          tstpln__set_segment_speed(LINKING_SPEED)
          tstpln__get_toolpath_interpolate(LINKING_STEP, PTH_LINETO, TRUE, pth)
      ENDSELECT
    UNTIL( tstpln__is_path_end )

    j = 1
    i=SAMPLE_START
    WHILE i <= SAMPLE_END DO
      act_path[j] = pth[i].v
      i = i + 1
      j = j + 1
    ENDWHILE

    exp_path[1] = POS(29.432,16.549,0,-180,0,0, (ZEROPOS(1).config_data))
    exp_path[2] = POS(40.204,17.549,0,-180,0,0, (ZEROPOS(1).config_data))
    exp_path[3] = POS(50.975,18.549,0,-180,0,0, (ZEROPOS(1).config_data))
    exp_path[4] = POS(61.746,19.549,0,-180,0,0, (ZEROPOS(1).config_data))
    exp_path[5] = POS(72.517,20.549,0,-180,0,0, (ZEROPOS(1).config_data))
    exp_path[6] = POS(83.288,21.549,0,-180,0,0, (ZEROPOS(1).config_data))
    exp_path[7] = POS(83.288,21.549,0,-180,0,0, (ZEROPOS(1).config_data))
    exp_path[8] = POS(77.236,21.549,0,-180,0,0, (ZEROPOS(1).config_data))
    exp_path[9] = POS(71.183,21.549,0,-180,0,0, (ZEROPOS(1).config_data))
    exp_path[10] = POS(65.131,21.549,0,-180,0,0, (ZEROPOS(1).config_data))
    exp_path[11] = POS(59.079,21.549,0,-180,0,0, (ZEROPOS(1).config_data))

    RETURN(kunit_eq_arp(exp_path, act_path))

  END t_hex_pnts


ROUTINE t_pads : BOOLEAN
  VAR
%define PAD_WIDTH 60
%define PAD_LENGTH 150
%defeval PAD_SEPERATION (30+PAD_WIDTH)
%define NO_OF_PADS 3

%define RASTER_ANGLE 0
%define PASS_OVERLAP 10
%define CONTOUR_LINES 1
%define TOOLING_STEP 20
%define LINKING_STEP 50
%define RETRACT_HEIGHT -20
%define TOOLING_SPEED 20
%define LINKING_SPEED 60
    origin : XYZWPR
    bbox : t_RECT
%define SAMPLE_START 99
%define SAMPLE_END 119
    i, j : INTEGER
    act_path, exp_path : ARRAY[11] OF XYZWPR
  BEGIN
    -- ** drawing **
    --draw pads
    clear_poly(polygon)
    tstpoly__init((ZEROPOS(1)), TRUE)
    tstpoly__set_canvas( POS(0,0,0,0,0,0,(ZEROPOS(1).config_data)) )
    tstpoly__pads(PAD_WIDTH, PAD_LENGTH, PAD_SEPERATION, NO_OF_PADS, VEC2D(50,0) )

    --get raster lines
    -- (start_angle, dir, wall_lines, line_width, line_pitch)
    tstpoly__set_params(RASTER_ANGLE, 1, CONTOUR_LINES, 0, PASS_OVERLAP)
    tstpoly__raster(PTH_LINETO)
    --get lines and contours
    paths__clear_vecpath(lines)
    paths__clear_vecpath(contours)
    tstpoly__lines_to_vec_path(lines)
    tstpoly__contours_to_vec_path(contours)

    -- ** planning **
    origin = POS(0,0,0,-30,0,0, pose__set_config(RBT_CONFIG))
    --generate path
    tstpln__init(lines, origin)
    --(poly_depend, strict_dir)
    tstpln__raster_graph(ONEWAY, TRUE, TRUE)
    -- (add to kd tree)
    tstpln__append_path(contours, FALSE)
     --get start node
    bbox = tstpoly__get_bounding_box
    tstpln__MST(tstpln__closest_bounding_box(2))
    --set point orientation
    tstpln__set_orientation(DOWN_NORMAL)

    clear_list(path_plan)
    tstpln__get_plan(path_plan)

    paths__clear_toolpath(pth)
    REPEAT
      SELECT (tstpln__next_toolpath) OF
        CASE(PTH_TOOLING):
          tstpln__set_segment_speed(TOOLING_SPEED)
          tstpln__get_toolpath_interpolate(TOOLING_STEP, PTH_LINETO, TRUE, pth)
        CASE(PTH_LINKING):
          tstpln__set_segment_speed(LINKING_SPEED)
          tstpln__get_toolpath_interpolate(LINKING_STEP, PTH_LINETO, TRUE, pth)
      ENDSELECT
    UNTIL( tstpln__is_path_end )

    --raise linking path
    -- paths__offset_toolpath(pth, POS(0,0,RETRACT_HEIGHT,0,0,0,(ZEROPOS(1).config_data)), PTH_NULL, PTH_LINKING)

    j = 1
    i=SAMPLE_START
    WHILE i <= SAMPLE_END DO
      act_path[j] = pth[i].v
      i = i + 2
      j = j + 1
    ENDWHILE

    exp_path[1] = POS(200,0,0,150,0,0,(ZEROPOS(1).config_data))
    exp_path[2] = POS(160,0,0,150,0,0, (ZEROPOS(1).config_data))
    exp_path[3] = POS(140,0,0,150,0,0, (ZEROPOS(1).config_data))
    exp_path[4] = POS(200,8.66,-5,150,0,0, (ZEROPOS(1).config_data))
    exp_path[5] = POS(160,8.66,-5,150,0,0, (ZEROPOS(1).config_data))
    exp_path[6] = POS(140,8.66,-5,150,0,0, (ZEROPOS(1).config_data))
    exp_path[7] = POS(200,17.321,-10,150,0,0, (ZEROPOS(1).config_data))
    exp_path[8] = POS(160,17.321,-10,150,0,0, (ZEROPOS(1).config_data))
    exp_path[9] = POS(140,17.321,-10,150,0,0, (ZEROPOS(1).config_data))
    exp_path[10] = POS(200,25.981,-15,150,0,0, (ZEROPOS(1).config_data))
    exp_path[11] = POS(160,25.981,-15,150,0,0, (ZEROPOS(1).config_data))

    RETURN(kunit_eq_arp(exp_path, act_path))
  END t_pads


ROUTINE t_lpads : BOOLEAN
  VAR
%define PAD_WIDTH 60
%define PAD_LENGTH 60
%defeval PAD_SEPERATION 90
%define NO_OF_PADS 3

%define RASTER_ANGLE 0
%define PASS_OVERLAP 10
%define CONTOUR_LINES 0
%define TOOLING_STEP 20
%define LINKING_STEP 50
%define TOOLING_SPEED 20
%define LINKING_SPEED 60
    origin : XYZWPR
    bbox : t_RECT
%define SAMPLE_START 50
%define SAMPLE_END 70
    i, j : INTEGER
    act_path, exp_path : ARRAY[11] OF XYZWPR
  BEGIN
    -- ** drawing **
    --draw pads
    clear_poly(polygon)
    tstpoly__init((ZEROPOS(1)), TRUE)
    tstpoly__set_canvas( POS(0,0,0,0,0,0,(ZEROPOS(1).config_data)) )
    tstpoly__pads(PAD_WIDTH, PAD_LENGTH, PAD_SEPERATION, NO_OF_PADS, VEC2D(50,0) )

    --get raster lines
    -- (start_angle, dir, wall_lines, line_width, line_pitch)
    tstpoly__set_params(RASTER_ANGLE, 1, CONTOUR_LINES, 0, PASS_OVERLAP)
    tstpoly__raster(PTH_LINETO)
    --get lines and contours
    paths__clear_vecpath(lines)
    paths__clear_vecpath(contours)
    tstpoly__lines_to_vec_path(lines)
    tstpoly__contours_to_vec_path(contours)

    -- ** planning **
    origin = POS(0,0,100,90,0,0, pose__set_config(RBT_CONFIG))
    --generate path
    tstpln__init(lines, origin)
    --(poly_depend, strict_dir)
    tstpln__raster_graph(ONEWAY, TRUE, TRUE)
    -- (add to kd tree)
    tstpln__append_path(contours, FALSE)
     --get start node
    bbox = tstpoly__get_bounding_box
    tstpln__MST(tstpln__closest_bounding_box(2))
    --set point orientation
    tstpln__set_orientation(VEC(90,0,0))

    clear_list(path_plan)
    tstpln__get_plan(path_plan)

    paths__clear_toolpath(pth)
    REPEAT
      SELECT (tstpln__next_toolpath) OF
        CASE(PTH_TOOLING):
          tstpln__set_segment_speed(TOOLING_SPEED)
          tstpln__get_toolpath_interpolate(TOOLING_STEP, PTH_LINETO, TRUE, pth)
        CASE(PTH_LINKING):
          tstpln__set_segment_speed(LINKING_SPEED)
          tstpln__get_toolpath_interpolate(LINKING_STEP, PTH_LINETO, TRUE, pth)
      ENDSELECT
    UNTIL( tstpln__is_path_end )

    j = 1
    i=SAMPLE_START
    WHILE i <= SAMPLE_END DO
      act_path[j] = pth[i].v
      i = i + 2
      j = j + 1
    ENDWHILE

    exp_path[1] = POS(180,0,110,-180,0,0,(ZEROPOS(1).config_data))
    exp_path[2] = POS(140,-0,110,-180, 0, 0, (ZEROPOS(1).config_data))
    exp_path[3] = POS(200,-0,120,-180, 0, 0, (ZEROPOS(1).config_data))
    exp_path[4] = POS(180,-0,120,-180, 0, 0, (ZEROPOS(1).config_data))
    exp_path[5] = POS(140,-0,120,-180, 0, 0, (ZEROPOS(1).config_data))
    exp_path[6] = POS(200,-0,130,-180, 0, 0, (ZEROPOS(1).config_data))
    exp_path[7] = POS(180,-0,130,-180, 0, 0, (ZEROPOS(1).config_data))
    exp_path[8] = POS(140,-0,130,-180, 0, 0, (ZEROPOS(1).config_data))
    exp_path[9] = POS(200,-0,140,-180, 0, 0, (ZEROPOS(1).config_data))
    exp_path[10] = POS(180,-0,140,-180, 0, 0, (ZEROPOS(1).config_data))
    exp_path[11] = POS(140,-0,140,-180, 0, 0, (ZEROPOS(1).config_data))

    RETURN(kunit_eq_arp(exp_path, act_path))
  END t_lpads


-- ****** clyindrical paths ********
-- *********************************

ROUTINE t_cyld_yaxe : BOOLEAN
-- ..warning drawing is flipped upside down. See `paths__offset_toolpath`
--           need to fix this
  VAR
    i, j : INTEGER
    origin : XYZWPR
    radius : REAL
    bbox : t_RECT
    apprch_pnt : t_VEC_PATH
%define SAMPLE_START 50
%define SAMPLE_END 70
%define TOOLING_STEP 6
%define LINKING_STEP 10
%define RETRACT_HEIGHT 10
%define TOOLING_SPEED 20
%define LINKING_SPEED 60
    act_path, exp_path : ARRAY[11] OF XYZWPR
  BEGIN
    
    --user frame
    origin = POS(0,0,0,0,0,0, (ZEROPOS(1).config_data))

    --draw polygon
    clear_poly(polygon)
    tstpoly__init((ZEROPOS(1)), TRUE)
    draw_delta(0, 10, 1)
    
      --get bounding box
    bbox = tstpoly__get_bounding_box
      --get contours
    paths__clear_vecpath(lines)
    tstpoly__lines_to_vec_path(lines)
    tstpoly__contours_to_vec_path(contours)

    --generate path
    radius = 50
    -- (theta, z, r)
    tstpln__init(lines, POS(0,0,radius,0,0,0, (ZEROPOS(1).config_data)))
    --(poly_depend, strict_dir)
    tstpln__raster_graph(ONEWAY, FALSE, FALSE)
      --append contours after to not include in rastering process
      -- (add to kd tree)
    tstpln__append_path(contours, FALSE)
    
     --get start nodetstpln__append_path(contours, FALSE)
    apprch_pnt = paths__new_vpath(bbox.verts[1], PTH_STOP, 0, VEC(1,0,0))
    tstpln__MST(tstpln__closest_point(apprch_pnt))

    paths__clear_toolpath(pth)

    --set point orientation
    tstpln__set_orientation(DOWN_NORMAL)

    REPEAT
      SELECT tstpln__next_toolpath OF
        CASE(PTH_TOOLING):
          tstpln__set_segment_speed(TOOLING_SPEED)
          tstpln__get_toolpath_interpolate(TOOLING_STEP, PTH_LINETO, TRUE, pth)
        CASE(PTH_LINKING):
          tstpln__set_segment_speed(LINKING_SPEED)
          tstpln__get_toolpath_interpolate(LINKING_STEP, PTH_LINETO, TRUE, pth)
      ENDSELECT

    UNTIL( tstpln__is_path_end )

    --raise linking path
    paths__offset_toolpath(pth, POS(0,0,-1*RETRACT_HEIGHT,0,0,0,(ZEROPOS(1).config_data)), PTH_NULL, PTH_LINKING)
    --convert coordinate systems
    tssrf__convertOrientation(pth, origin, radius, PTH_CYLINDER, Y_AXES, FALSE)

    j = 1
    i=SAMPLE_START
    WHILE i <= SAMPLE_END DO
      act_path[j] = pth[i].v
      i = i + 2
      j = j + 1
    ENDWHILE

    exp_path[1] = POS(20.7, 42.0, 56.3, 180.0, 20.2, 0.0, (ZEROPOS(1).config_data))
    exp_path[2] = POS(-3.8, 46.0, 59.9, 180.0, -3.7, 0.0, (ZEROPOS(1).config_data))
    exp_path[3] = POS(-27.7, 50.0, 53.2, 180.0, -27.5, 0.0, (ZEROPOS(1).config_data))
    exp_path[4] = POS(-17.6, 50.0, 46.8, -180.0, -20.6, 0.0, (ZEROPOS(1).config_data))
    exp_path[5] = POS(-6.0, 50.0, 49.6, -180.0, -6.9, 0.0, (ZEROPOS(1).config_data))
    exp_path[6] = POS(6.0, 50.0, 49.6, -180.0, 6.9, 0.0, (ZEROPOS(1).config_data))
    exp_path[7] = POS(17.6, 50.0, 46.8, -180.0, 20.6, 0.0, (ZEROPOS(1).config_data))
    exp_path[8] = POS(27.7, 50.0, 53.2, 180.0, 27.5, 0.0, (ZEROPOS(1).config_data))
    exp_path[9] = POS(2.4, 55.0, 60.0, 180.0, 2.3, 0.0, (ZEROPOS(1).config_data))
    exp_path[10] = POS(-23.4, 60.0, 55.3, 180.0, -22.9, 0.0, (ZEROPOS(1).config_data))
    exp_path[11] = POS(-13.2, 60.0, 48.2, -180.0, -15.3, 0.0, (ZEROPOS(1).config_data))

    RETURN(kunit_eq_arp(exp_path, act_path))

  END t_cyld_yaxe

ROUTINE t_cyld_xaxe : BOOLEAN
-- ..warning drawing is flipped upside down. See `paths__offset_toolpath`
--           need to fix this
  VAR
    i, j : INTEGER
    origin : XYZWPR
    radius : REAL
    bbox : t_RECT
    apprch_pnt : t_VEC_PATH
%define SAMPLE_START 50
%define SAMPLE_END 70
%define TOOLING_STEP 6
%define LINKING_STEP 10
%define RETRACT_HEIGHT 10
%define TOOLING_SPEED 20
%define LINKING_SPEED 60
    act_path, exp_path : ARRAY[11] OF XYZWPR
  BEGIN
    
    --user frame
    origin = POS(0,0,0,0,0,0, (ZEROPOS(1).config_data))

    --draw polygon
    clear_poly(polygon)
    tstpoly__init((ZEROPOS(1)), TRUE)
    draw_delta(0, 10, 1)
    
      --get bounding box
    bbox = tstpoly__get_bounding_box
      --get contours
    paths__clear_vecpath(lines)
    tstpoly__lines_to_vec_path(lines)
    tstpoly__contours_to_vec_path(contours)

    --generate path
    radius = 50
    -- (theta, z, r)
    tstpln__init(lines, POS(0,0,radius,0,0,0, (ZEROPOS(1).config_data)))
    --(poly_depend, strict_dir)
    tstpln__raster_graph(ONEWAY, FALSE, FALSE)
      --append contours after to not include in rastering process
      -- (add to kd tree)
    tstpln__append_path(contours, FALSE)
     --get start node
    apprch_pnt = paths__new_vpath(bbox.verts[1], PTH_STOP, 0, VEC(1,0,0))
    tstpln__MST(tstpln__closest_point(apprch_pnt))

    paths__clear_toolpath(pth)

    --set point orientation
    tstpln__set_orientation(DOWN_NORMAL)

    REPEAT
      SELECT tstpln__next_toolpath OF
        CASE(PTH_TOOLING):
          tstpln__set_segment_speed(TOOLING_SPEED)
          tstpln__get_toolpath_interpolate(TOOLING_STEP, PTH_LINETO, TRUE, pth)
        CASE(PTH_LINKING):
          tstpln__set_segment_speed(LINKING_SPEED)
          tstpln__get_toolpath_interpolate(LINKING_STEP, PTH_LINETO, TRUE, pth)
      ENDSELECT

    UNTIL( tstpln__is_path_end )

    --raise linking path
    paths__offset_toolpath(pth, POS(0,0,-1*RETRACT_HEIGHT,0,0,0,(ZEROPOS(1).config_data)), PTH_NULL, PTH_LINKING)
    --convert coordinate systems
    tssrf__convertOrientation(pth, origin, radius, PTH_CYLINDER, X_AXES, FALSE)

    j = 1
    i=SAMPLE_START
    WHILE i <= SAMPLE_END DO
      act_path[j] = pth[i].v
      i = i + 2
      j = j + 1
    ENDWHILE

    exp_path[1] = POS(42.0, -20.7, 56.3, 200.2, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[2] = POS(46.0, 3.8, 59.9, 176.3, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[3] = POS(50.0, 27.7, 53.2, 152.5, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[4] = POS(50.0, 17.6, 46.8, -200.6, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[5] = POS(50.0, 6.0, 49.6, -186.9, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[6] = POS(50.0, -6.0, 49.6, -173.1, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[7] = POS(50.0, -17.6, 46.8, -159.4, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[8] = POS(50.0, -27.7, 53.2, 207.5, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[9] = POS(55.0, -2.4, 60.0, 182.3, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[10] = POS(60.0, 23.4, 55.3, 157.1, 0.0, 0.0, (ZEROPOS(1).config_data))
    exp_path[11] = POS(60.0, 13.2, 48.2, -195.3, 0.0, 0.0, (ZEROPOS(1).config_data))

    RETURN(kunit_eq_arp(exp_path, act_path))

  END t_cyld_xaxe


ROUTINE t_cyld_zaxe : BOOLEAN
-- ..warning drawing is flipped upside down. See `paths__offset_toolpath`
--           need to fix this
  VAR
    i, j : INTEGER
    origin : XYZWPR
    radius : REAL
    bbox : t_RECT
    apprch_pnt : t_VEC_PATH
%define SAMPLE_START 50
%define SAMPLE_END 70
%define TOOLING_STEP 6
%define LINKING_STEP 10
%define RETRACT_HEIGHT 10
%define TOOLING_SPEED 20
%define LINKING_SPEED 60
    act_path, exp_path : ARRAY[11] OF XYZWPR
  BEGIN
    
    --user frame
    origin = POS(0,0,0,0,0,0, (ZEROPOS(1).config_data))

    --draw polygon
    clear_poly(polygon)
    tstpoly__init((ZEROPOS(1)), TRUE)
    draw_delta(0, 10, 1)
    
      --get bounding box
    bbox = tstpoly__get_bounding_box
      --get contours
    paths__clear_vecpath(lines)
    paths__clear_vecpath(contours)
    tstpoly__lines_to_vec_path(lines)
    tstpoly__contours_to_vec_path(contours)

    --generate path
    radius = 50
    -- (theta, z, r)
    tstpln__init(lines, POS(0,radius,0,90,0,180, (ZEROPOS(1).config_data)))
    --(poly_depend, strict_dir)
    tstpln__raster_graph(ONEWAY, FALSE, FALSE)
      --append contours after to not include in rastering process
      -- (add to kd tree)
    tstpln__append_path(contours, FALSE)
     --get start node
    apprch_pnt = paths__new_vpath(bbox.verts[1], PTH_STOP, 0, VEC(1,0,0))
    tstpln__MST(tstpln__closest_point(apprch_pnt))

    paths__clear_toolpath(pth)

    --set point orientation
    tstpln__set_orientation(DOWN_NORMAL)

    REPEAT
      SELECT tstpln__next_toolpath OF
        CASE(PTH_TOOLING):
          tstpln__set_segment_speed(TOOLING_SPEED)
          tstpln__get_toolpath_interpolate(TOOLING_STEP, PTH_LINETO, TRUE, pth)
        CASE(PTH_LINKING):
          tstpln__set_segment_speed(LINKING_SPEED)
          tstpln__get_toolpath_interpolate(LINKING_STEP, PTH_LINETO, TRUE, pth)
      ENDSELECT

    UNTIL( tstpln__is_path_end )

    --raise linking path
    paths__offset_toolpath(pth, POS(0,0,-1*RETRACT_HEIGHT,0,0,0,(ZEROPOS(1).config_data)), PTH_NULL, PTH_LINKING)
    --convert coordinate systems
    tssrf__convertOrientation(pth, origin, radius, PTH_CYLINDER, Z_AXES, FALSE)
    

    j = 1
    i=SAMPLE_START
    WHILE i <= SAMPLE_END DO
      act_path[j] = pth[i].v
      i = i + 2
      j = j + 1
    ENDWHILE

    exp_path[1] = POS(20.7, 56.3, 42.0, -90.0, 0.0, 159.8, (ZEROPOS(1).config_data))
    exp_path[2] = POS(-3.8, 59.9, 46.0, -90.0, 0.0, 183.7, (ZEROPOS(1).config_data))
    exp_path[3] = POS(-27.7, 53.2, 50.0, -90.0, 0.0, 207.5, (ZEROPOS(1).config_data))
    exp_path[4] = POS(-17.6, 46.8, 50.0, -90.0, 0.0, -159.4, (ZEROPOS(1).config_data))
    exp_path[5] = POS(-6.0, 49.6, 50.0, -90.0, 0.0, -173.1, (ZEROPOS(1).config_data))
    exp_path[6] = POS(6.0, 49.6, 50.0, -90.0, 0.0, -186.9, (ZEROPOS(1).config_data))
    exp_path[7] = POS(17.6, 46.8, 50.0, -90.0, 0.0, -200.6, (ZEROPOS(1).config_data))
    exp_path[8] = POS(27.7, 53.2, 50.0, -90.0, 0.0, 152.5, (ZEROPOS(1).config_data))
    exp_path[9] = POS(2.4, 60.0, 55.0, -90.0, 0.0, 177.7, (ZEROPOS(1).config_data))
    exp_path[10] = POS(-23.4, 55.3, 60.0, -90.0, 0.0, 202.9, (ZEROPOS(1).config_data))
    exp_path[11] = POS(-13.2, 48.2, 60.0, -90.0, 0.0, -164.7, (ZEROPOS(1).config_data))

    RETURN(kunit_eq_arp(exp_path, act_path))

  END t_cyld_zaxe


ROUTINE t_pvert_OD : BOOLEAN
  VAR
%define PAD_RADIUS 100
-- pad width 60 deg
%define PAD_WIDTH 60
%define PAD_LENGTH 150
-- pad sep 30 deg
%defeval PAD_SEPERATION (30+PAD_WIDTH)
%define NO_OF_PADS 3
%defeval RETRACT_HEIGHT 20

%define RASTER_ANGLE 0
%define PASS_OVERLAP 10
%define CONTOUR_LINES 0
%define TOOLING_STEP 10
%define LINKING_STEP 15
%define TOOLING_SPEED 20
%define LINKING_SPEED 60
    origin : XYZWPR
    bbox : t_RECT
    apprch_pnt : t_VEC_PATH
%define SAMPLE_START 100
%define SAMPLE_END 120
    i, j : INTEGER
    act_path, exp_path : ARRAY[11] OF XYZWPR
  BEGIN
    -- ** drawing **
    --draw pads
    clear_poly(polygon)
    tstpoly__init((ZEROPOS(1)), TRUE)
    tstpoly__pads(PAD_WIDTH, PAD_LENGTH, PAD_SEPERATION, NO_OF_PADS, VEC2D(0,0) )

    --get raster lines
    -- (start_angle, dir, wall_lines, line_width, line_pitch)
    tstpoly__set_params(RASTER_ANGLE, 1, CONTOUR_LINES, 0, PASS_OVERLAP)
    tstpoly__raster(PTH_LINETO)
    --get lines and contours
    paths__clear_vecpath(lines)
    paths__clear_vecpath(contours)
    tstpoly__lines_to_vec_path(lines)
    tstpoly__contours_to_vec_path(contours)

    -- ** planning **
    --generate path
    tstpln__init(lines, POS(0,0,PAD_RADIUS,0,0,0, (ZEROPOS(1).config_data)))
    --(poly_depend, strict_dir)
    tstpln__raster_graph(ONEWAY, TRUE, TRUE)
    -- (add to kd tree)
    tstpln__append_path(contours, FALSE)
     --get start node
    bbox = tstpoly__get_bounding_box
    tstpln__MST(tstpln__closest_bounding_box(1))
    -- apprch_pnt = paths__new_vpath(bbox.verts[2], PTH_STOP, 0)
    -- tstpln__MST(tstpln__closest_point(apprch_pnt))
    --set point orientation
    tstpln__set_orientation(DOWN_NORMAL_VERT)

    clear_list(path_plan)
    tstpln__get_plan(path_plan)

    paths__clear_toolpath(pth)
    REPEAT
      SELECT (tstpln__next_toolpath) OF
        CASE(PTH_TOOLING):
          tstpln__set_segment_speed(TOOLING_SPEED)
          tstpln__get_toolpath_interpolate(TOOLING_STEP, PTH_LINETO, TRUE, pth)
        CASE(PTH_LINKING):
          tstpln__set_segment_speed(LINKING_SPEED)
          tstpln__get_toolpath_interpolate(LINKING_STEP, PTH_LINETO, TRUE, pth)
      ENDSELECT
    UNTIL( tstpln__is_path_end )

    --raise linking path
    paths__offset_toolpath(pth, POS(0,0,RETRACT_HEIGHT,0,0,0,(ZEROPOS(1).config_data)), PTH_NULL, PTH_LINKING)
    --convert coordinate systems
    origin = POS(100,100,0,0,0,0, pose__set_config(RBT_CONFIG))
    tspth__convertOrientation(pth, origin, PAD_RADIUS, PTH_CYLINDER, VERT_AXES, FALSE)

    j = 1
    i=SAMPLE_START
    WHILE i <= SAMPLE_END DO
      act_path[j] = pth[i].v
      i = i + 2
      j = j + 1
    ENDWHILE

    exp_path[1] = POS(25.7, 166.9, 80.0, -90.0, 0.0, -132.0, (ZEROPOS(1).config_data))
    exp_path[2] = POS(-3.9, 160.0, 80.0, -90.0, 0.0, 240.0, (ZEROPOS(1).config_data))
    exp_path[3] = POS(40.0, 203.9, 85.0, -90.0, 0.0, 210.0, (ZEROPOS(1).config_data))
    exp_path[4] = POS(100.0, 220.0, 90.0, -90.0, 0.0, 180.0, (ZEROPOS(1).config_data))
    exp_path[5] = POS(79.2, 197.8, 90.0, -90.0, 0.0, -168.0, (ZEROPOS(1).config_data))
    exp_path[6] = POS(41.2, 180.9, 90.0, -90.0, 0.0, -144.0, (ZEROPOS(1).config_data))
    exp_path[7] = POS(13.4, 150.0, 90.0, -90.0, 0.0, -120.0, (ZEROPOS(1).config_data))
    exp_path[8] = POS(15.1, 184.9, 92.5, -90.0, 0.0, 225.0, (ZEROPOS(1).config_data))
    exp_path[9] = POS(68.9, 215.9, 97.5, -90.0, 0.0, 195.0, (ZEROPOS(1).config_data))
    exp_path[10] = POS(100.0, 200.0, 100.0, -90.0, 0.0, -180.0, (ZEROPOS(1).config_data))
    exp_path[11] = POS(59.3, 191.4, 100.0, -90.0, 0.0, -156.0, (ZEROPOS(1).config_data))

    RETURN(kunit_eq_arp(exp_path, act_path))
  END t_pvert_OD


ROUTINE t_pvert_ID : BOOLEAN
  VAR
%define PAD_RADIUS 100
%define PAD_WIDTH 60
%define PAD_LENGTH 150
%defeval PAD_SEPERATION (30+PAD_WIDTH)
%define NO_OF_PADS 3
%defeval RETRACT_HEIGHT (60-PAD_RADIUS)

%define RASTER_ANGLE 0
%define PASS_OVERLAP 10
%define CONTOUR_LINES 0
%define TOOLING_STEP 20
%define LINKING_STEP 50
%define TOOLING_SPEED 20
%define LINKING_SPEED 60
    origin : XYZWPR
    bbox : t_RECT
%define SAMPLE_START 200
%define SAMPLE_END 220
    i, j : INTEGER
    act_path, exp_path : ARRAY[11] OF XYZWPR
  BEGIN
    -- ** drawing **
    --draw pads
    clear_poly(polygon)
    tstpoly__init((ZEROPOS(1)), TRUE)
    tstpoly__set_canvas( POS(0,0,0,0,0,0,(ZEROPOS(1).config_data)) )
    tstpoly__pads(PAD_WIDTH, PAD_LENGTH, PAD_SEPERATION, NO_OF_PADS, VEC2D(0,0) )

    --get raster lines
    -- (start_angle, dir, wall_lines, line_width, line_pitch)
    tstpoly__set_params(RASTER_ANGLE, 1, CONTOUR_LINES, 0, PASS_OVERLAP)
    tstpoly__raster(PTH_LINETO)
    --get lines and contours
    paths__clear_vecpath(lines)
    paths__clear_vecpath(contours)
    tstpoly__lines_to_vec_path(lines)
    tstpoly__contours_to_vec_path(contours)

    -- ** planning **
    --generate path
    tstpln__init(lines, POS(0,0,PAD_RADIUS,0,0,0, (ZEROPOS(1).config_data)))
    --(poly_depend, strict_dir)
    tstpln__raster_graph(ONEWAY, TRUE, TRUE)
    -- (add to kd tree)
    tstpln__append_path(contours, FALSE)
     --get start node
    bbox = tstpoly__get_bounding_box
    tstpln__MST(tstpln__closest_bounding_box(1))
    --set point orientation
    tstpln__set_orientation(UP_NORMAL)

    paths__clear_toolpath(pth)
    REPEAT
      SELECT (tstpln__next_toolpath) OF
        CASE(PTH_TOOLING):
          tstpln__set_segment_speed(TOOLING_SPEED)
          tstpln__get_toolpath_interpolate(TOOLING_STEP, PTH_LINETO, TRUE, pth)
        CASE(PTH_LINKING):
          tstpln__set_segment_speed(LINKING_SPEED)
          tstpln__get_toolpath_interpolate(LINKING_STEP, PTH_LINETO, TRUE, pth)
      ENDSELECT
    UNTIL( tstpln__is_path_end )
    
    --lower linking path
    paths__offset_toolpath(pth, POS(0,0,RETRACT_HEIGHT,0,0,0,(ZEROPOS(1).config_data)), PTH_NULL, PTH_LINKING)
    --convert coordinate systems
    origin = POS(0,0,0,0,0,0, pose__set_config(RBT_CONFIG))
    tspth__convertOrientation(pth, origin, PAD_RADIUS, PTH_CYLINDER, VERT_AXES, FALSE)

    j = 1
    i=SAMPLE_START
    WHILE i <= SAMPLE_END DO
      act_path[j] = pth[i].v
      i = i + 2
      j = j + 1
    ENDWHILE

    exp_path[1] = POS(-0.0, -100.0, 20.0, -90.0, 0.0, 180.0,(ZEROPOS(1).config_data))
    exp_path[2] = POS(64.3, -76.6, 20.0, -90.0, 0.0, -140.0, (ZEROPOS(1).config_data))
    exp_path[3] = POS(52.0, -30.0, 20.0, -90.0, 0.0, -120.0, (ZEROPOS(1).config_data))
    exp_path[4] = POS(-0.0, -100.0, 30.0, -90.0, 0.0, 180.0, (ZEROPOS(1).config_data))
    exp_path[5] = POS(64.3, -76.6, 30.0, -90.0, 0.0, -140.0, (ZEROPOS(1).config_data))
    exp_path[6] = POS(52.0, -30.0, 30.0, -90.0, 0.0, -120.0, (ZEROPOS(1).config_data))
    exp_path[7] = POS(-0.0, -100.0, 40.0, -90.0, 0.0, 180.0, (ZEROPOS(1).config_data))
    exp_path[8] = POS(64.3, -76.6, 40.0, -90.0, 0.0, -140.0, (ZEROPOS(1).config_data))
    exp_path[9] = POS(52.0, -30.0, 40.0, -90.0, 0.0, -120.0, (ZEROPOS(1).config_data))
    exp_path[10] = POS(-0.0, -100.0, 50.0, -90.0, 0.0, 180.0, (ZEROPOS(1).config_data))
    exp_path[11] = POS(64.3, -76.6, 50.0, -90.0, 0.0, -140.0, (ZEROPOS(1).config_data))

    RETURN(kunit_eq_arp(exp_path, act_path))
  END t_pvert_ID

ROUTINE t_porient_OD : BOOLEAN
  VAR
%define PAD_RADIUS 100
-- pad width 60 deg
%defeval PAD_WIDTH PAD_RADIUS*60*3.14159/180
%define PAD_LENGTH 150
-- pad sep 30 deg
%defeval PAD_SEPERATION (PAD_RADIUS*30*3.14159/180+PAD_WIDTH)
%define NO_OF_PADS 1
%defeval RETRACT_HEIGHT 20

%define RASTER_ANGLE 45
%define PASS_OVERLAP 10
%define CONTOUR_LINES 0
%define TOOLING_STEP 10
%define LINKING_STEP 15
%define TOOLING_SPEED 20
%define LINKING_SPEED 60
    origin : XYZWPR
    bbox : t_RECT
    apprch_pnt : t_VEC_PATH
%define SAMPLE_START 100
%define SAMPLE_END 120
    i, j : INTEGER
    act_path, exp_path : ARRAY[11] OF XYZWPR
  BEGIN
    -- ** drawing **
    --draw pads
    clear_poly(polygon)
    tstpoly__init((ZEROPOS(1)), TRUE)
    tstpoly__set_canvas( POS(0,0,0,0,0,0,(ZEROPOS(1).config_data)) )
    tstpoly__pads(PAD_WIDTH, PAD_LENGTH, PAD_SEPERATION, NO_OF_PADS, VEC2D(0,0) )

    --get raster lines
    -- (start_angle, dir, wall_lines, line_width, line_pitch)
    tstpoly__set_params(RASTER_ANGLE, 1, CONTOUR_LINES, 0, PASS_OVERLAP)
    tstpoly__raster(PTH_LINETO)
    --get lines and contours
    paths__clear_vecpath(lines)
    paths__clear_vecpath(contours)
    tstpoly__lines_to_vec_path(lines)
    tstpoly__contours_to_vec_path(contours)

    -- ** planning **
    --generate path
    tstpln__init(lines, POS(0,0,PAD_RADIUS,0,0,0, (ZEROPOS(1).config_data)))
    --(poly_depend, strict_dir)
    tstpln__raster_graph(ONEWAY, TRUE, TRUE)
    -- (add to kd tree)
    tstpln__append_path(contours, FALSE)
     --get start node
    bbox = tstpoly__get_bounding_box
    tstpln__MST(tstpln__closest_bounding_box(3))
    --set point orientation
    tstpln__set_orientation(DOWN_NORMAL_VERT)

    clear_list(path_plan)
    tstpln__get_plan(path_plan)

    paths__clear_toolpath(pth)
    REPEAT
      SELECT (tstpln__next_toolpath) OF
        CASE(PTH_TOOLING):
          tstpln__set_segment_speed(TOOLING_SPEED)
          tstpln__get_toolpath_interpolate(TOOLING_STEP, PTH_LINETO, TRUE, pth)
        CASE(PTH_LINKING):
          tstpln__set_segment_speed(LINKING_SPEED)
          tstpln__get_toolpath_interpolate(LINKING_STEP, PTH_LINETO, TRUE, pth)
      ENDSELECT
    UNTIL( tstpln__is_path_end )

    --raise linking path
    paths__offset_toolpath(pth, POS(0,0,RETRACT_HEIGHT,0,0,0,(ZEROPOS(1).config_data)), PTH_NULL, PTH_LINKING)
    --convert coordinate systems
    origin = POS(100,100,0,0,0,0, pose__set_config(RBT_CONFIG))
    tsorn__convertOrientation(pth, origin, PAD_RADIUS, PTH_CYLINDER, VERT_AXES, FALSE)

    j = 1
    i=SAMPLE_START
    WHILE i <= SAMPLE_END DO
      act_path[j] = pth[i].v
      i = i + 2
      j = j + 1
    ENDWHILE

    exp_path[1] = POS(6.6, 175.3, 138.7, 90.0, -45.0, -128.9, (ZEROPOS(1).config_data))
    exp_path[2] = POS(23.2, 192.2, 116.0, 90.0, -45.0, -140.2, (ZEROPOS(1).config_data))
    exp_path[3] = POS(42.9, 205.6, 93.4, 90.0, -45.0, -151.6, (ZEROPOS(1).config_data))
    exp_path[4] = POS(64.8, 214.7, 70.7, 90.0, -45.0, -163.0, (ZEROPOS(1).config_data))
    exp_path[5] = POS(88.1, 219.4, 48.0, 90.0, -45.0, -174.3, (ZEROPOS(1).config_data))
    exp_path[6] = POS(100.0, 200.0, 36.7, 90.0, -45.0, -180.0, (ZEROPOS(1).config_data))
    exp_path[7] = POS(85.1, 198.9, 51.7, 90.0, -45.0, -171.4, (ZEROPOS(1).config_data))
    exp_path[8] = POS(70.5, 195.6, 66.6, 90.0, -45.0, -162.9, (ZEROPOS(1).config_data))
    exp_path[9] = POS(56.6, 190.1, 81.6, 90.0, -45.0, -154.3, (ZEROPOS(1).config_data))
    exp_path[10] = POS(43.7, 182.6, 96.5, 90.0, -45.0, -145.7, (ZEROPOS(1).config_data))
    exp_path[11] = POS(32.0, 173.3, 111.5, 90.0, -45.0, -137.1, (ZEROPOS(1).config_data))

    RETURN(kunit_eq_arp(exp_path, act_path))
  END t_porient_OD

ROUTINE t_delta_ornt : BOOLEAN
  VAR
%define PAD_RADIUS 50
%defeval RETRACT_HEIGHT 20

%define RASTER_ANGLE 45
%define PASS_OVERLAP 10
%define CONTOUR_LINES 0
%define TOOLING_STEP 10
%define LINKING_STEP 15
%define TOOLING_SPEED 20
%define LINKING_SPEED 60
    origin : XYZWPR
    bbox : t_RECT
    apprch_pnt : t_VEC_PATH
%define SAMPLE_START 50
%define SAMPLE_END 70
    i, j : INTEGER
    act_path, exp_path : ARRAY[11] OF XYZWPR
  BEGIN
    --user frame
    origin = POS(0,0,0,0,0,0, (ZEROPOS(1).config_data))

    -- ** drawing **
    clear_poly(polygon)
    tstpoly__init((ZEROPOS(1)), TRUE)
    tstpoly__set_canvas( POS(0,0,0,0,0,0,(ZEROPOS(1).config_data)) )
    draw_delta(RASTER_ANGLE, PASS_OVERLAP, 1)

    --get lines and contours
    paths__clear_vecpath(lines)
    paths__clear_vecpath(contours)
    tstpoly__lines_to_vec_path(lines)
    tstpoly__contours_to_vec_path(contours)

    -- ** planning **
    --generate path
    tstpln__init(lines, POS(0,0,PAD_RADIUS,0,0,0,(ZEROPOS(1).config_data)))
    --(poly_depend, strict_dir)
    tstpln__raster_graph(ONEWAY, FALSE, FALSE)
    -- (add to kd tree)
    tstpln__append_path(contours, FALSE)
     --get start node
     bbox = tstpoly__get_bounding_box
    --    -- Contour last
    apprch_pnt = paths__new_vpath(bbox.verts[1], PTH_STOP, 0, VEC(1,0,0))
    tstpln__MST(tstpln__closest_point(apprch_pnt))
      --Contour first
    -- tstpln__MST(tstpln__closest_bounding_box(1))
    --set point orientation
    tstpln__set_orientation(DOWN_NORMAL_VERT)

    clear_list(path_plan)
    tstpln__get_plan(path_plan)

    paths__clear_toolpath(pth)
    REPEAT
      SELECT (tstpln__next_toolpath) OF
        CASE(PTH_TOOLING):
          tstpln__set_segment_speed(TOOLING_SPEED)
          tstpln__get_toolpath_interpolate(TOOLING_STEP, PTH_LINETO, TRUE, pth)
        CASE(PTH_LINKING):
          tstpln__set_segment_speed(LINKING_SPEED)
          tstpln__get_toolpath_interpolate(LINKING_STEP, PTH_LINETO, TRUE, pth)
      ENDSELECT
    UNTIL( tstpln__is_path_end )

    --raise linking path
    paths__offset_toolpath(pth, POS(0,0,RETRACT_HEIGHT,0,0,0,(ZEROPOS(1).config_data)), PTH_NULL, PTH_LINKING)
    --convert coordinate systems
    tsorn__convertOrientation(pth, origin, PAD_RADIUS, PTH_CYLINDER, VERT_AXES, TRUE)

    j = 1
    i=SAMPLE_START
    WHILE i <= SAMPLE_END DO
      act_path[j] = pth[i].v
      i = i + 2
      j = j + 1
    ENDWHILE

    exp_path[1] = POS(18.0, 46.6, 64.7, 270.0, -45.0, 158.9, (ZEROPOS(1).config_data))
    exp_path[2] = POS(-0.0, 50.0, 83.1, 270.0, -45.0, -180.0, (ZEROPOS(1).config_data))
    exp_path[3] = POS(-12.8, 68.8, 92.4, 270.0, -45.0, -169.4, (ZEROPOS(1).config_data))
    exp_path[4] = POS(11.3, 48.7, 85.9, 270.0, -45.0, 167.0, (ZEROPOS(1).config_data))
    exp_path[5] = POS(-5.7, 49.7, 103.0, 270.0, -45.0, -173.5, (ZEROPOS(1).config_data))
    exp_path[6] = POS(6.0, 69.7, 107.1, 270.0, -45.0, 175.1, (ZEROPOS(1).config_data))
    exp_path[7] = POS(-2.1, 50.0, 113.6, 270.0, -45.0, -177.5, (ZEROPOS(1).config_data))
    exp_path[8] = POS(-11.3, 69.1, 96.9, 270.0, -45.0, -170.7, (ZEROPOS(1).config_data))
    exp_path[9] = POS(-27.3, 64.5, 63.5, 270.0, -45.0, -157.1, (ZEROPOS(1).config_data))
    exp_path[10] = POS(-41.7, 56.2, 30.2, 270.0, -45.0, -143.4, (ZEROPOS(1).config_data))
    exp_path[11] = POS(-24.7, 43.5, 24.1, 270.0, -45.0, -150.4, (ZEROPOS(1).config_data))

    RETURN(kunit_eq_arp(exp_path, act_path))
  END t_delta_ornt


-- ****** spherical paths ********
-- *******************************

ROUTINE t_pol_pnts : BOOLEAN
  VAR
    i, j : INTEGER
    origin : XYZWPR
    bbox : t_RECT
    apprch_pnt : t_VEC_PATH
%define PAD_RADIUS 50
%define SAMPLE_START 50
%define SAMPLE_END 70
%define TOOLING_STEP 6
%define LINKING_STEP 10
%defeval RETRACT_HEIGHT 10
%define TOOLING_SPEED 20
%define LINKING_SPEED 60
    act_path, exp_path : ARRAY[11] OF XYZWPR
  BEGIN
    
    --user frame
    origin = POS(0,0,0,0,0,0, (ZEROPOS(1).config_data))

    --draw polygon
    draw_delta(0, 10, 1)
    
      --get bounding box
    bbox = tstpoly__get_bounding_box
      --get contours
    paths__clear_vecpath(lines)
    tstpoly__lines_to_vec_path(lines)
    tstpoly__contours_to_vec_path(contours)

    --generate path
    -- 50 = radius
    -- (theta, z, r)
    tstpln__init(lines, POS(0,0,PAD_RADIUS,0,0,0, (ZEROPOS(1).config_data))) --cylindrical
    --(poly_depend, strict_dir)
    tstpln__raster_graph(ONEWAY, FALSE, FALSE)
      --append contours after to not include in rastering process
      -- (add to kd tree)
    tstpln__append_path(contours, FALSE)
     --get start node
    apprch_pnt = paths__new_vpath(bbox.verts[1], PTH_STOP, 0, VEC(1,0,0))
    tstpln__MST(tstpln__closest_point(apprch_pnt))

    clear_list(path_plan)
    tstpln__get_plan(path_plan)

    paths__clear_toolpath(pth)
    --set point orientation
    tstpln__set_orientation(POLAR_DOWN_NORMAL)

    REPEAT
      SELECT tstpln__next_toolpath OF
        CASE(PTH_TOOLING):
          tstpln__set_segment_speed(TOOLING_SPEED)
          tstpln__get_toolpath_interpolate(TOOLING_STEP, PTH_LINETO, TRUE, pth)
        CASE(PTH_LINKING):
          tstpln__set_segment_speed(LINKING_SPEED)
          tstpln__get_toolpath_interpolate(LINKING_STEP, PTH_LINETO, TRUE, pth)
      ENDSELECT

    UNTIL( tstpln__is_path_end )

    --offset linking path
    paths__offset_toolpath(pth, POS(0,RETRACT_HEIGHT,0,0,0,0,(ZEROPOS(1).config_data)), PTH_NULL, PTH_LINKING)
    --convert coordinate systems
    tssrf__convertOrientation(pth, origin, PAD_RADIUS, PTH_POLAR, Z_AXES, FALSE)

    j = 1
    i=SAMPLE_START
    WHILE i <= SAMPLE_END DO
      act_path[j] = pth[i].v
      i = i + 2
      j = j + 1
    ENDWHILE

    exp_path[1] = POS(15.4, 40.0, 41.9, 138.1, 20.2, 0.0, (ZEROPOS(1).config_data))
    exp_path[2] = POS(-3.1, 36.3, 47.6, 142.7, -3.7, 0.0, (ZEROPOS(1).config_data))
    exp_path[3] = POS(-23.3, 32.4, 44.8, 147.3, -27.5, 0.0, (ZEROPOS(1).config_data))
    exp_path[4] = POS(-14.8, 27.0, 39.4, 147.3, -20.6, 0.0, (ZEROPOS(1).config_data))
    exp_path[5] = POS(-5.0, 27.0, 41.8, 147.3, -6.9, 0.0, (ZEROPOS(1).config_data))
    exp_path[6] = POS(5.0, 27.0, 41.8, 147.3, 6.9, 0.0, (ZEROPOS(1).config_data))
    exp_path[7] = POS(14.8, 27.0, 39.4, 147.3, 20.6, 0.0, (ZEROPOS(1).config_data))
    exp_path[8] = POS(23.3, 32.4, 44.8, 147.3, 27.5, 0.0, (ZEROPOS(1).config_data))
    exp_path[9] = POS(2.1, 27.2, 53.4, 153.0, 2.3, 0.0, (ZEROPOS(1).config_data))
    exp_path[10] = POS(-21.8, 21.7, 51.5, 158.8, -22.9, 0.0, (ZEROPOS(1).config_data))
    exp_path[11] = POS(-12.3, 18.1, 45.0, 158.8, -15.3, 0.0, (ZEROPOS(1).config_data))

    RETURN(kunit_eq_arp(exp_path, act_path))

  END t_pol_pnts

BEGIN
%ifdef DEBUG_BUILD
  --(log_filename, show_date, show_debug, show_info)
  usrdis__new(LOG_NAME, FALSE, FALSE, TRUE)
  usrdis__clear_file
%endif

  -- ** use kunit
  -- ..warning:: Unit tests may error out if run in a full batch
  --             break up into smaller batch sizes, or run one at
  --             a time
  -- flat paths
  kunit_test('draw delta path', t_flat_pnts)
  kunit_test('hexagon path', t_hex_pnts)
  kunit_test('multiple pads path', t_pads)
  kunit_test('multiple pads path vertical', t_lpads)
  -- clyindrical paths
  kunit_test('draw delta cylinder y-axis', t_cyld_yaxe)
  kunit_test('draw delta cylinder x-axis', t_cyld_xaxe)
  kunit_test('draw delta cylinder z-axis', t_cyld_zaxe)
  kunit_test('pads vertical path OD', t_pvert_OD)
  kunit_test('pads vertical path ID', t_pvert_ID)
  kunit_test('pads vertical path OD orientation', t_porient_OD)
  kunit_test('pads vertical path OD orientation', t_delta_ornt)
  -- polar paths
  kunit_test('polar coordinates path planning', t_pol_pnts)
  kunit_done

  -- clean up
  tstpoly__delete
  tstpln__delete

%ifdef DEBUG_BUILD
  usrdis__write_pipe
  usrdis__delete
%endif

END test_paths